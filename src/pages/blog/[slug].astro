---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import ScrollToTop from '../../components/ScrollToTop.astro';
import { getAllPosts, getPost, toEasyIOUrl, getSeoDescription, getSeoTitle, getOgTitle, getOgDescription, getTwitterTitle, getTwitterDescription, getSocialImage } from '../../lib/wordpress';
import '../../styles/global.css';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { slug } = Astro.params;
const post = await getPost(slug);
const categories = post._embedded?.['wp:term']?.[0] || [];
const featuredImage = toEasyIOUrl(post._embedded?.['wp:featuredmedia']?.[0]?.media_details?.sizes?.large?.source_url || post._embedded?.['wp:featuredmedia']?.[0]?.source_url);

// Get SEO title and description (from SEO plugin or fallback)
const seoTitle = getSeoTitle(post);
const seoDescription = getSeoDescription(post);

// Get OG/Twitter specific values
const ogTitle = getOgTitle(post);
const ogDescription = getOgDescription(post);
const twitterTitle = getTwitterTitle(post);
const twitterDescription = getTwitterDescription(post);
const socialImage = toEasyIOUrl(getSocialImage(post)) || featuredImage;

// Calculate reading time
const wordCount = post.content.rendered.replace(/<[^>]*>/g, '').split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead 
			title={seoTitle} 
			description={seoDescription}
			image={socialImage}
			ogTitle={ogTitle}
			ogDescription={ogDescription}
			twitterTitle={twitterTitle}
			twitterDescription={twitterDescription}
		/>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@wordpress/block-library@latest/build-style/style.min.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@wordpress/block-library@latest/build-style/theme.min.css">
	</head>
	<body>
		<Header />
		<main class="container mx-auto px-4 py-12 max-w-5xl">
			<article class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
				{featuredImage && (
					<img 
						src={featuredImage} 
						alt={post.title.rendered}
						class="w-full h-96 object-cover"
					/>
				)}
				
				<div class="p-8 md:p-12">
					{categories.length > 0 && (
						<div class="flex gap-2 mb-6 flex-wrap">
							{categories.map(cat => (
								<span class="text-xs font-medium bg-blue-50 text-blue-700 px-3 py-1.5 rounded uppercase tracking-wide">
									{cat.name}
								</span>
							))}
						</div>
					)}
					
					<h1 class="text-4xl md:text-5xl font-bold mb-6 text-gray-900 leading-tight" set:html={post.title.rendered} />
					
					<div class="flex items-center gap-4 text-sm text-gray-500 mb-8 pb-8 border-b border-gray-200">
						<time class="font-medium">
							{new Date(post.date).toLocaleDateString('en-GB', { 
								year: 'numeric', 
								month: 'long', 
								day: 'numeric' 
							})}
						</time>
						<span>â€¢</span>
						<span>{readingTime} min read</span>
					</div>
					
					<div class="prose prose-lg mx-auto" set:html={post.content.rendered} />
				</div>
			</article>
			
			<a 
				href="/" 
				class="inline-flex items-center mt-8 text-blue-600 hover:text-blue-700 font-semibold transition-colors group"
			>
				<svg class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
				</svg>
				Back to home
			</a>
		</main>
		<Footer />
		<ScrollToTop />
	</body>
</html>
